services:
  broker:
    build:
      context: ./broker
      dockerfile: ../Dockerfile.python
    container_name: broker
    ports:
      - "5555:5555"
      - "5556:5556"
    networks:
      - messaging

  proxy:
    build:
      context: ./proxy
      dockerfile: ../Dockerfile.python
    container_name: proxy
    ports:
      - "5557:5557"
      - "5558:5558"
    networks:
      - messaging

  reference:
    build:
      context: ./reference
      dockerfile: ../Dockerfile.python
    container_name: reference
    ports:
      - "5559:5559"
    networks:
      - messaging

  server:
    build:
      context: ./server
      dockerfile: ../Dockerfile.python
    volumes:
      - server-data:/app/data
    depends_on:
      - broker
      - proxy
      - reference
    networks:
      - messaging
    deploy:
      replicas: 3

  client:
    build:
      context: ./client
      dockerfile: ../Dockerfile.node
    stdin_open: true
    tty: true
    depends_on:
      - broker
      - proxy
    networks:
      - messaging

  bot:
    build:
      context: ./bot
      dockerfile: ../Dockerfile.go
    depends_on:
      - broker
      - proxy
      - server
    networks:
      - messaging
    deploy:
      replicas: 2

networks:
  messaging:
    driver: bridge

volumes:
  server-data:
